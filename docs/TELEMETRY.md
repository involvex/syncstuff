# Telemetry Service

The `@syncstuff/telemetry` package provides a centralized telemetry service for the SyncStuff ecosystem, leveraging OpenTelemetry and Axiom for observability.

## Overview

This service is a Cloudflare Worker that acts as a collector and exporter for telemetry data (traces, metrics, logs) generated by other parts of the system.

## Architecture

*   **Runtime:** Cloudflare Workers
*   **Instrumentation:** OpenTelemetry (OTel)
*   **Exporter:** OTLP over HTTP to Axiom
*   **Library:** `@microlabs/otel-cf-workers`

## Setup & Configuration

### Environment Variables

The service requires the following environment variables to be set in `.env` (or Cloudflare secrets):

*   `AXIOM_API_TOKEN`: Your Axiom API token with ingest permissions.
*   `AXIOM_DATASET`: The name of the Axiom dataset to send data to.

### Development

To start the telemetry worker locally:

```bash
pnpm --filter @syncstuff/telemetry dev
```

### Deployment

To deploy the telemetry worker to Cloudflare:

```bash
pnpm run deploy:telemetry
```

## Integration

Other services (API, Web, etc.) can send traces to this worker or directly to Axiom using the OpenTelemetry SDKs configured with the appropriate OTLP exporter settings.

### Example Usage (in another worker)

To instrument another Cloudflare Worker to send traces to Axiom (via this setup pattern):

1.  Install dependencies:
    ```bash
    pnpm add @microlabs/otel-cf-workers @opentelemetry/api
    ```

2.  Configure `index.ts`:
    ```typescript
    import { instrument, ResolveConfigFn } from '@microlabs/otel-cf-workers';

    const config: ResolveConfigFn = (env: Env, _trigger) => {
      return {
        exporter: {
          url: 'https://api.axiom.co/v1/traces',
          headers: {
            'Authorization': `Bearer ${env.AXIOM_API_TOKEN}`,
            'X-Axiom-Dataset': `${env.AXIOM_DATASET}`
          },
        },
        service: { name: 'my-service-name' },
      };
    };

    const handler = {
        async fetch(req, env, ctx) {
            // ... your code
        }
    }

    export default instrument(handler, config);
    ```

## Monitoring

Telemetry data can be visualized and analyzed in the [Axiom Dashboard](https://app.axiom.co/).
